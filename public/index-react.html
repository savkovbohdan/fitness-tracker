<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí™ –§–∏—Ç–Ω–µ—Å-–¢—Ä–µ–∫–µ—Ä</title>
    <link rel="stylesheet" href="styles/modern.css">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script src="components.js"></script>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [screen, setScreen] = useState('main');
            const [exercises, setExercises] = useState([]);
            const [selectedExercise, setSelectedExercise] = useState(null);
            const [savedSets, setSavedSets] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [success, setSuccess] = useState(null);
            
            // States for workout
            const [weight, setWeight] = useState('');
            const [reps, setReps] = useState('');
            const [useBodyweight, setUseBodyweight] = useState(false);
            
            // States for adding exercise
            const [showAddForm, setShowAddForm] = useState(false);
            const [newExercise, setNewExercise] = useState({ name: '', category: '–≥—Ä—É–¥—å', photo_url: '' });
            const [addingExercise, setAddingExercise] = useState(false);
            const [uploadingPhoto, setUploadingPhoto] = useState(false);
            const fileInputRef = useRef(null);
            
            // States for history
            const [workoutHistory, setWorkoutHistory] = useState([]);

            // Load exercises
            useEffect(() => {
                loadExercises();
            }, []);

            const loadExercises = async () => {
                setLoading(true);
                try {
                    const response = await axios.get('/api/exercises');
                    setExercises(response.data);
                } catch (err) {
                    setError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π');
                    console.error('Error loading exercises:', err);
                } finally {
                    setLoading(false);
                }
            };

            const selectExercise = (exercise) => {
                setSelectedExercise(exercise);
                setScreen('workout');
                setSavedSets([]);
                setError(null);
                setSuccess(null);
                setWeight('');
                setReps('');
                setUseBodyweight(false);
            };

            const addSet = async () => {
                if (!reps.trim()) {
                    setError('–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π');
                    return;
                }

                if (!useBodyweight && !weight.trim()) {
                    setError('–í–≤–µ–¥–∏—Ç–µ –≤–µ—Å –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ "–°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–µ—Å"');
                    return;
                }

                try {
                    const response = await axios.post('/api/workout-sets', {
                        exercise_id: selectedExercise.id,
                        reps: parseInt(reps),
                        weight: useBodyweight ? '–°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–µ—Å' : parseFloat(weight)
                    });

                    setSavedSets([...savedSets, response.data]);
                    setSuccess('–ü–æ–¥—Ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω!');
                    setReps('');
                    setWeight('');
                    
                    setTimeout(() => setSuccess(null), 2000);
                } catch (err) {
                    setError(err.response?.data?.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ–¥—Ö–æ–¥–∞');
                }
            };

            const finishWorkout = () => {
                setSuccess(`–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ø–æ–¥—Ö–æ–¥–æ–≤: ${savedSets.length}`);
                setTimeout(() => {
                    setScreen('main');
                    setSelectedExercise(null);
                    setSavedSets([]);
                }, 2000);
            };

            const uploadPhoto = async (file) => {
                if (!file) return;
                
                setUploadingPhoto(true);
                const formData = new FormData();
                formData.append('photo', file);

                try {
                    const response = await axios.post('/api/upload-exercise-photo', formData, {
                        headers: { 'Content-Type': 'multipart/form-data' }
                    });
                    setNewExercise({...newExercise, photo_url: response.data.photo_url});
                    setSuccess('–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!');
                    
                    setError(null);
                } catch (err) {
                    setError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ: ' + (err.response?.data?.error || err.message));
                } finally {
                    setUploadingPhoto(false);
                }
            };

            const addExercise = async () => {
                if (!newExercise.name.trim()) {
                    setError('–ù–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ');
                    return;
                }

                setAddingExercise(true);
                try {
                    const response = await axios.post('/api/exercises', newExercise);
                    setSuccess(`–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ "${newExercise.name}" –¥–æ–±–∞–≤–ª–µ–Ω–æ!`);
                    
                    setTimeout(() => {
                        setNewExercise({ name: '', category: '–≥—Ä—É–¥—å', photo_url: '' });
                        setShowAddForm(false);
                    }, 2000);
                    
                    loadExercises();
                } catch (err) {
                    setError(err.response?.data?.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è');
                } finally {
                    setAddingExercise(false);
                }
            };

            const loadWorkoutHistory = async () => {
                setLoading(true);
                try {
                    const response = await axios.get('/api/workout-logs/1');
                    setWorkoutHistory(response.data);
                } catch (err) {
                    setError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏');
                    console.error('Error loading workout history:', err);
                    setWorkoutHistory([]);
                } finally {
                    setLoading(false);
                }
            };

            // Clear messages
            useEffect(() => {
                if (error) {
                    const timer = setTimeout(() => setError(null), 3000);
                    return () => clearTimeout(timer);
                }
            }, [error]);

            return (
                <div className="fade-in">
                    {screen === 'main' && (
                        <MainScreen 
                            setScreen={setScreen} 
                            error={error} 
                            success={success} 
                        />
                    )}
                    {screen === 'exercises' && (
                        <ExercisesScreen 
                            exercises={exercises}
                            loading={loading}
                            showAddForm={showAddForm}
                            newExercise={newExercise}
                            addingExercise={addingExercise}
                            uploadingPhoto={uploadingPhoto}
                            fileInputRef={fileInputRef}
                            setShowAddForm={setShowAddForm}
                            setNewExercise={setNewExercise}
                            selectExercise={selectExercise}
                            addExercise={addExercise}
                            uploadPhoto={uploadPhoto}
                        />
                    )}
                    {screen === 'workout' && selectedExercise && (
                        <WorkoutScreen 
                            selectedExercise={selectedExercise}
                            savedSets={savedSets}
                            error={error}
                            success={success}
                            weight={weight}
                            reps={reps}
                            useBodyweight={useBodyweight}
                            setWeight={setWeight}
                            setReps={setReps}
                            setUseBodyweight={setUseBodyweight}
                            addSet={addSet}
                            finishWorkout={finishWorkout}
                        />
                    )}
                    {screen === 'history' && (
                        <HistoryScreen 
                            workoutHistory={workoutHistory}
                            loading={loading}
                            loadWorkoutHistory={loadWorkoutHistory}
                        />
                    )}
                    {screen === 'stats' && <StatsScreen />}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
