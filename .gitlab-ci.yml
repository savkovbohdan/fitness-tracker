stages:
  - build
  - deploy

variables:
  NODE_VERSION: "18"
  PORT: "5001"

build:
  stage: build
  image: node:18-alpine
  script:
    - echo "ðŸ—ï¸ Building Fitness Tracker..."
    - npm ci
    - npm run build  # ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð±Ð¸Ð»Ð´ ÑÐºÑ€Ð¸Ð¿Ñ‚
  artifacts:
    paths:
      - node_modules/
      - public/
      - server.js
      - package.json
    expire_in: 1 hour

deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $SSH_SERVER_IP >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - echo "ðŸš€ Deploying to server..."
    - |
      ssh $SSH_USER@$SSH_SERVER_IP "
        set -e
        
        echo 'ðŸ“¦ Updating system...'
        apt update && apt upgrade -y
        
        echo 'ðŸ“¦ Installing Node.js...'
        curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | bash -
        apt-get install -y nodejs
        
        echo 'ðŸ“¦ Installing PM2...'
        npm install -g pm2
        
        echo 'ðŸ“ Creating app directory...'
        mkdir -p /var/www/fitness-tracker
        cd /var/www/fitness-tracker
        
        echo 'ðŸ“‹ Stopping current app...'
        pm2 stop fitness-tracker || true
        pm2 delete fitness-tracker || true
        
        echo 'ðŸ“‚ Cleaning old files...'
        rm -rf * || true
        
        echo 'ðŸ“¦ Copying new files...'
        # Ð—Ð´ÐµÑÑŒ Ñ„Ð°Ð¹Ð»Ñ‹ Ð±ÑƒÐ´ÑƒÑ‚ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ Ñ‡ÐµÑ€ÐµÐ· scp
      "
    
    # ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
    - |
      scp -r node_modules/ $SSH_USER@$SSH_SERVER_IP:/var/www/fitness-tracker/
      scp -r public/ $SSH_USER@$SSH_SERVER_IP:/var/www/fitness-tracker/
      scp server.js $SSH_USER@$SSH_SERVER_IP:/var/www/fitness-tracker/
      scp package.json $SSH_USER@$SSH_SERVER_IP:/var/www/fitness-tracker/
    
    - |
      ssh $SSH_USER@$SSH_SERVER_IP "
        cd /var/www/fitness-tracker
        
        echo 'ðŸ”§ Setting permissions...'
        chown -R www-data:www-data /var/www/fitness-tracker
        chmod -R 755 /var/www/fitness-tracker
        
        echo 'ðŸŒ Configuring Nginx...'
        apt install -y nginx || true
        
        cat > /etc/nginx/sites-available/fitness << 'NGINX'
server {
    listen 80;
    server_name _;
    location / {
        proxy_pass http://localhost:${PORT};
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;
    }
}
NGINX
        
        ln -sf /etc/nginx/sites-available/fitness /etc/nginx/sites-enabled/
        rm -f /etc/nginx/sites-enabled/default
        systemctl restart nginx || true
        systemctl enable nginx || true
        
        echo 'ðŸ”¥ Configuring firewall...'
        ufw allow ${PORT}/tcp || true
        ufw allow 22/tcp || true
        ufw --force enable || true
        
        echo 'ðŸš€ Starting application...'
        pm2 start server.js --name fitness-tracker
        pm2 startup
        pm2 save
        
        echo 'ðŸŽ‰ Deployment completed!'
        echo 'ðŸŒ Application URL: http://$(curl -s ifconfig.me 2>/dev/null || echo ${SSH_SERVER_IP})'
      "
  only:
    - main
  when: manual
